<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>í¬íŠ¸ì› ê²°ì œ í…ŒìŠ¤íŠ¸</title>
    <script src="https://cdn.portone.io/v2/browser-sdk.js"></script>
</head>
<body>
    <h1>í¬íŠ¸ì› ê²°ì œ í…ŒìŠ¤íŠ¸</h1>
    <button onclick="requestPayment()">ê²°ì œí•˜ê¸°</button>
    <button onclick="requestRefund('ORDER_1738572873704_36026')">í™˜ë¶ˆ ìš”ì²­</button>
    <button onclick="requestSubscription()">ì •ê¸° ê²°ì œ ì‹ ì²­</button>
    <button onclick="cancelSubscription()">ì •ê¸° ê²°ì œ ì·¨ì†Œ</button>

    <script>
function generatePaymentId() {
    return `ORDER_${Date.now()}_${Math.floor(Math.random() * 100000)}`;
}


async function requestPayment() {
    const userId = "550e8400-e29b-41d4-a716-446655440000";  // âœ… ì˜ˆì œ UUID
    const subId = 1;  // âœ… êµ¬ë… ID
    const paymentId = generatePaymentId();  // âœ… ê³ ìœ í•œ ê²°ì œ ID ìƒì„±


    try {
        // âœ… Django ì„œë²„ì—ì„œ ìƒí’ˆ ì •ë³´ ê°€ì ¸ì˜¤ê¸°
        const itemResponse = await fetch('/api/payment/item/');
        const item = await itemResponse.json();

        if (!item || item.error) {
            alert("ìƒí’ˆ ì •ë³´ë¥¼ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
            return;
        }

        console.log("ğŸŸ¢ ìƒí’ˆ ì •ë³´:", item);

        // âœ… Django ì„œë²„ì—ì„œ ê²°ì œ ìš”ì²­ ìƒì„±
        const response = await fetch('/api/payment/request/', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ user_id: userId, sub_id: subId })
        });

        const data = await response.json();

        if (!response.ok) {
            alert(`ê²°ì œ ìš”ì²­ ì‹¤íŒ¨: ${data.error}`);
            return;
        }

        // âœ… í¬íŠ¸ì› V2 ê²°ì œ ìš”ì²­
        const payment = await PortOne.requestPayment({
            storeId: "store-c25c9523-5081-4aae-a882-ce7e52479c59",
            channelKey: "channel-key-4ac61816-307a-4820-9e6d-98e4df50a949",
            paymentId: paymentId,
            orderName: 'Basic Plan',  // âœ… ìƒí’ˆ ì •ë³´ ì‚¬ìš©
            totalAmount: item.price,  // âœ… ìƒí’ˆ ê°€ê²© ì‚¬ìš©
            currency: "KRW",
            payMethod: "CARD",
            customData: {
                sub_id: subId,  // âœ… êµ¬ë… ID ì „ë‹¬
            },
        });

        console.log("ğŸŸ¢ ê²°ì œ ì‘ë‹µ:", payment);

        if (payment.code !== undefined) {
            alert("ê²°ì œ ì‹¤íŒ¨: " + payment.message);
            return;
        }

        // âœ… Django ì„œë²„ì— ê²°ì œ ì™„ë£Œ ì²˜ë¦¬ ìš”ì²­
        await fetch('/api/payment/complete/', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ paymentId: payment.paymentId })
        }).then(res => res.json()).then(data => {
            if (data.status === "PAID") {
                alert("âœ… ê²°ì œ ì„±ê³µ!");
            } else {
                alert("âŒ ê²°ì œ ê²€ì¦ ì‹¤íŒ¨");
            }
        });

    } catch (error) {
        console.error("âŒ ê²°ì œ ìš”ì²­ ì˜¤ë¥˜:", error);
        alert("ê²°ì œ ìš”ì²­ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
    }
}

async function requestRefund() {
            const impUid = prompt("í™˜ë¶ˆí•  ê²°ì œì˜ imp_uidë¥¼ ì…ë ¥í•˜ì„¸ìš”:");

            if (!impUid) {
                alert("imp_uidê°€ í•„ìš”í•©ë‹ˆë‹¤.");
                return;
            }

            try {
                const response = await fetch('/api/payment/cancel/', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ imp_uid: impUid, reason: "ì‚¬ìš©ì ìš”ì²­" })
                });

                const data = await response.json();

                if (!response.ok) {
                    alert(`í™˜ë¶ˆ ì‹¤íŒ¨: ${data.error}`);
                    return;
                }

                alert(`âœ… í™˜ë¶ˆ ì„±ê³µ! í™˜ë¶ˆ ê¸ˆì•¡: ${data.refund_amount}ì›`);
            } catch (error) {
                console.error("âŒ í™˜ë¶ˆ ìš”ì²­ ì˜¤ë¥˜:", error);
                alert("í™˜ë¶ˆ ìš”ì²­ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
            }
        }


async function requestSubscription() {
            const userId = "550e8400-e29b-41d4-a716-446655440000";  // ì˜ˆì œ UUID
            const planId = 1;  // ìš”ê¸ˆì œ ID

            try {
                const response = await fetch('/api/payment/subscribe/', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ user_id: userId, plan_id: planId })
                });

                const data = await response.json();

                if (!response.ok) {
                    alert(`ì •ê¸° ê²°ì œ ì‹¤íŒ¨: ${data.error}`);
                    return;
                }

                alert(`âœ… ì •ê¸° ê²°ì œ ì„±ê³µ! ê²°ì œ ID: ${data.payment_id}`);
            } catch (error) {
                console.error("âŒ ì •ê¸° ê²°ì œ ìš”ì²­ ì˜¤ë¥˜:", error);
                alert("ì •ê¸° ê²°ì œ ìš”ì²­ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
            }
        }

async function cancelSubscription() {
    const userId = "550e8400-e29b-41d4-a716-446655440000";  // ì˜ˆì œ UUID

    try {
        const response = await fetch('/api/payment/cancel-subscription/', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ user_id: userId })
        });

        const data = await response.json();

        if (!response.ok) {
            alert(`êµ¬ë… ì·¨ì†Œ ì‹¤íŒ¨: ${data.error}`);
            return;
        }

        alert("âœ… ì •ê¸° ê²°ì œ ì·¨ì†Œ ì™„ë£Œ!");
    } catch (error) {
        console.error("âŒ êµ¬ë… ì·¨ì†Œ ì˜¤ë¥˜:", error);
        alert("êµ¬ë… ì·¨ì†Œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
    }
}
    </script>
</body>
</html>